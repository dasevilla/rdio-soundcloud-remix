//! rdioUtils 0.0.3
//! Built on 2013-07-31
//! https://github.com/rdio/jsapi-examples/tree/master/utils
//! Copyright 2013, Rdio, Inc.
//! Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
!function(a){function b(a){var b=document.getElementsByTagName("body")[0],c=document.createElement("div");c.className="rdio-utils-dialog",c.innerHTML="<div>"+a+"</div><br><button>OK</button>";var d=c.getElementsByTagName("button")[0];rdioUtils._bind(d,"click",function(){b.removeChild(c)}),b.appendChild(c)}var c=!1;window.rdioUtils={startupChecks:function(){return a?(a.on("flashError",function(){b("The Rdio API requires Flash in this browser. Please install (or unblock) the Flash plug-in.")}),a.on("cookieError",function(){b("The Rdio API won't work while cookies are blocked. Please unblock cookies for rdio.com.")}),!0):(b("Unable to contact Rdio API. Please try again later."),!1)},addToTopOfQueue:function(b){var c=function(d,e,f){d.get("key")==b&&(a.player.queue.off("add",c),a.player.queue.move(f.index,0))};a.player.queue.on("add",c),a.player.queue.add(b)},collectionAlbums:function(a){return new this.CollectionTracker(a)},authWidget:function(b){var c=this;b.jquery&&(b=b[0]);var d=function(){b.innerHTML=a.currentUser.get("firstName")+" "+a.currentUser.get("lastName")};a.ready(function(){a.authenticated()?d():(b.innerHTML="<button>Sign In With Rdio</button>",c._bind(b,"click",function(){a.authenticate(function(a){a&&d()})}))})},albumWidget:function(a){return new this.AlbumWidget(a)},_bind:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!0):a.attachEvent("on"+b,c)},_unbind:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!0):a.detachEvent("on"+b,c)},_stopEvent:function(a){a.preventDefault?(a.preventDefault(),a.stopPropagation()):(a.cancelBubble=!0,a.returnValue=!1)},_escape:function(a){return a+="",a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},_log:function(){c&&window.console&&console.log&&console.log.apply(console,arguments)},_assert:function(a,b){window.console&&(console.assert?console.assert(a,b):a&&console.error&&console.error("[rdioUtils] assert failed: "+b))}}}(window.__rdio),function(a,b){b.AlbumWidget=function(c){if(this._element=document.createElement("div"),this._element.className="rdio-utils-album",this._broken=!(c&&c.url&&c.icon&&c.name&&c.artist&&c.artistUrl&&c.length&&c.key&&/^(a|al)[0-9]/.test(c.key)),this._broken)return this._element.innerHTML='<div class="rdio-utils-album-cover"><div class="rdio-utils-album-icon"></div></div><div class="rdio-utils-album-title rdio-utils-truncated">Unknown Album</div><div class="rdio-utils-album-author rdio-utils-truncated">&nbsp;</div><div class="rdio-utils-album-size rdio-utils-truncated">&nbsp;</div>',void 0;this._element.innerHTML='<div class="rdio-utils-album-cover"><a href="http://www.rdio.com'+b._escape(c.url)+'" target="_blank">'+'<div class="rdio-utils-album-icon" style="background-image: url('+b._escape(c.icon)+')"></div>'+'<div class="rdio-utils-album-hover-overlay">'+'<div class="rdio-utils-album-play-btn"></div>'+"</div>"+"</a>"+"</div>"+'<div class="rdio-utils-album-title rdio-utils-truncated"><a href="http://www.rdio.com'+b._escape(c.url)+'" target="_blank">'+b._escape(c.name)+"</a></div>"+'<div class="rdio-utils-album-author rdio-utils-truncated"><a href="http://www.rdio.com'+b._escape(c.artistUrl)+'" target="_blank">'+b._escape(c.artist)+"</a></div>"+'<div class="rdio-utils-album-size rdio-utils-truncated">'+b._escape(c.length)+" songs</div>";var d=this._element.getElementsByClassName("rdio-utils-album-play-btn")[0];b._bind(d,"click",function(d){b._stopEvent(d),(d.altKey||d.metaKey)&&a.player.queue.addPlayingSource(),a.player.play({source:c.key})})},b.AlbumWidget.prototype={element:function(){return this._element},broken:function(){return this._broken},_openActionMenu:function(){}}}(window.__rdio,window.rdioUtils),function(a,b){b.CollectionTracker=function(c){var d=this;if(this._config={onLoadComplete:c.onLoadComplete,onAlbumsLoaded:c.onAlbumsLoaded,onError:c.onError,onAdded:c.onAdded,onRemoved:c.onRemoved},c.localStorage&&window.JSON)try{var e="__rdioUtilsTestKey";localStorage.setItem(e,e),localStorage.removeItem(e),this._config.localStorage=!0}catch(f){}this._start=0,this._loading=null,this._albums=[],this._albumsByKey={},this._newAlbums=[],this._newAlbumsByKey={},this._firstTime=!0,this._bigExtras="-*,releaseDate,duration,isClean,canStream,icon,canSample,name,isExplicit,artist,url,length,trackKeys,artistUrl";var g=function(){if(d._config.localStorage){var c=localStorage.__rdioUtilsCollectionAlbums;if(c){var e=JSON.parse(c);if(e instanceof Array&&e.length){for(var f,g=0;g<e.length;g++)f=e[g],d._albumsByKey[f.key]=f;d._albums=e,d.length=d._albums.length,d._firstTime=!1,d._config.onAlbumsLoaded&&d._config.onAlbumsLoaded(e),d._config.onLoadComplete&&d._config.onLoadComplete();var h=localStorage.__rdioUtilsCollectionVersion;h!=a.currentUser.get("libraryVersion")&&d._startLoad()}}}d._firstTime&&d._startLoad(),a.currentUser.on("change:libraryVersion",function(a){b._log("change:libraryVersion: "+a),d._loading?(d._loading.loadAgain=!0,d._firstTime||(b._assert(d._loading.request,"_loading.request must exist"),d._loading.request.abort())):d._startLoad()})};a.ready(function(){if(a.authenticated())g();else{var b=function(c){c&&(a.off("change:authenticated",b),g())};a.on("change:authenticated",b)}})},b.CollectionTracker.prototype={at:function(a){return this._albums[a]},_startLoad:function(){b._log("_startLoad"),this._start=0,this._newAlbums=[],this._newAlbumsByKey={},this._loading={},this._firstTime?(this._count=100,this._extras=this._bigExtras+",albumKey,rawArtistKey"):(this._count=1e3,this._extras="-*,albumKey"),this._load()},_load:function(){b._log("_load");var c=this;b._assert(this._loading,"_loading must exist"),b._assert(!this._loading.request,"_loading.request must not exist"),this._loading.request=a.request({method:"getAlbumsInCollection",content:{user:a.currentUser.get("key"),start:this._start,count:this._count,extras:this._extras,sort:"playCount"},success:function(a){if(c._loading.request=null,a.result.length){for(var b,d=0;d<a.result.length;d++)b=a.result[d],b.key=b.albumKey,delete b.albumKey,b.artistKey=b.rawArtistKey,delete b.rawArtistKey,c._newAlbums.push(b),c._newAlbumsByKey[b.key]=b;c._firstTime&&c._config.onAlbumsLoaded&&c._config.onAlbumsLoaded(a.result)}if(a.result.length==c._count)c._start+=c._count,c._load();else{var e=[],f=[];if(c._firstTime)c._albums=c._newAlbums,c._albumsByKey=c._newAlbumsByKey;else{var g;for(g in c._newAlbumsByKey)c._albumsByKey[g]||e.push(g);for(g in c._albumsByKey)c._newAlbumsByKey[g]||f.push(g);if(e.length)return c._getAlbums(e,function(a){c._finishLoad(a,f)}),void 0}c._finishLoad([],f)}},error:function(a){b._log("_load error: "+a.status),c._loading.request=null,"abort"!=a.status&&c._config.onError&&c._config.onError(a.message),c._loadingDone()}})},_getAlbums:function(c,d){b._log("_getAlbums");var e=this;b._assert(this._loading,"_loading must exist"),b._assert(!this._loading.request,"_loading.request must not exist");var f=200,g=c.slice(0,f),h=c.slice(f);this._loading.request=a.request({method:"get",content:{keys:g.join(","),extras:this._bigExtras+",key,artistKey"},success:function(a){e._loading.request=null;var b,c=[];for(var f in a.result)b=a.result[f],c.push(b);h.length?e._getAlbums(h,function(a){d(c.concat(a))}):d(c)},error:function(a){b._log("_getAlbums error: "+a.status),e._loading.request=null,"abort"!=a.status&&e._config.onError&&e._config.onError(a.message),e._loadingDone()}})},_finishLoad:function(a,b){var c,d,e=[];for(c=0;c<b.length;c++){d=b[c],e.push(this._albumsByKey[d]),delete this._albumsByKey[d];for(var f=0;f<this._albums.length;f++)if(this._albums[f].key==d){this._albums.splice(f,1);break}}var g;for(c=0;c<a.length;c++)g=a[c],this._albums.push(g),this._albumsByKey[g.key]=g;var h=this._firstTime;this._newAlbums=[],this._newAlbumsByKey={},this.length=this._albums.length,this._firstTime=!1,this._save(),h&&this._config.onLoadComplete&&this._config.onLoadComplete(),a.length&&this._config.onAdded&&this._config.onAdded(a),e.length&&this._config.onRemoved&&this._config.onRemoved(e),this._loadingDone()},_loadingDone:function(){b._assert(this._loading,"_loading must exist"),b._assert(!this._loading.request,"_loading.request must not exist");var a=this._loading.loadAgain;this._loading=null,a&&this._startLoad()},_save:function(){if(this._config.localStorage){var b=JSON.stringify(this._albums);localStorage.__rdioUtilsCollectionAlbums=b,localStorage.__rdioUtilsCollectionVersion=a.currentUser.get("libraryVersion")}}}}(window.__rdio,window.rdioUtils);